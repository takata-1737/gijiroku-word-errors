<!DOCTYPE html>
<html lang="ja" xmlns:mso="urn:schemas-microsoft-com:office:office" xmlns:msdt="uuid:C2F41010-65B3-11d1-A29F-00AA00C14882">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>議事録専門用語修正ツール（拡張版）</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
        }
        .section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
        }
        .section h3 {
            margin-top: 0;
            color: #2c3e50;
            border-bottom: 2px solid #3498db;
            padding-bottom: 10px;
        }
        .tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 2px solid #ecf0f1;
        }
        .tab {
            padding: 10px 20px;
            cursor: pointer;
            border: none;
            background: none;
            color: #7f8c8d;
            font-size: 16px;
            border-bottom: 2px solid transparent;
        }
        .tab.active {
            color: #3498db;
            border-bottom-color: #3498db;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        textarea {
            width: 100%;
            height: 200px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 14px;
            resize: vertical;
        }
        .file-input {
            margin: 10px 0;
        }
        .btn {
            background-color: #3498db;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin: 5px;
            transition: background-color 0.3s;
        }
        .btn:hover {
            background-color: #2980b9;
        }
        .btn-success {
            background-color: #27ae60;
        }
        .btn-success:hover {
            background-color: #229954;
        }
        .btn-warning {
            background-color: #f39c12;
        }
        .btn-warning:hover {
            background-color: #e67e22;
        }
        .btn-danger {
            background-color: #e74c3c;
        }
        .btn-danger:hover {
            background-color: #c0392b;
        }
        .changes-list {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 15px;
            margin-top: 10px;
            max-height: 300px;
            overflow-y: auto;
        }
        .change-item {
            margin: 5px 0;
            padding: 8px;
            background-color: #e7f3ff;
            border-left: 4px solid #3498db;
            border-radius: 3px;
            font-family: 'Consolas', 'Monaco', monospace;
        }
        .regex-change-item {
            background-color: #f0f8e7;
            border-left-color: #27ae60;
        }
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            background-color: #ecf0f1;
            padding: 20px;
            border-radius: 8px;
            margin: 15px 0;
        }
        .stat-item {
            text-align: center;
            padding: 10px;
            background: white;
            border-radius: 5px;
        }
        .stat-number {
            font-size: 28px;
            font-weight: bold;
            color: #2c3e50;
        }
        .dictionary-item {
            display: flex;
            margin: 8px 0;
            align-items: center;
            padding: 10px;
            background-color: #f8f9fa;
            border-radius: 5px;
        }
        .dictionary-item input {
            margin: 0 10px;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            flex: 1;
        }
        .dictionary-item button {
            padding: 6px 12px;
            font-size: 14px;
        }
        .regex-rule-item {
            display: flex;
            margin: 8px 0;
            align-items: center;
            padding: 10px;
            background-color: #f0f8e7;
            border-radius: 5px;
        }
        .regex-rule-item input {
            margin: 0 5px;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-family: 'Consolas', 'Monaco', monospace;
        }
        .regex-pattern {
            flex: 2;
        }
        .regex-replacement {
            flex: 1;
        }
        .regex-description {
            flex: 2;
            font-size: 12px;
            color: #666;
        }
        .checkbox-group {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 10px;
            margin: 15px 0;
        }
        .checkbox-item {
            display: flex;
            align-items: center;
            padding: 10px;
            background-color: #f8f9fa;
            border-radius: 5px;
        }
        .checkbox-item input[type="checkbox"] {
            margin-right: 10px;
            transform: scale(1.2);
        }
        .preview-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 20px;
        }
        .preview-before, .preview-after {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            border: 1px solid #dee2e6;
        }
        .preview-before h4 {
            color: #e74c3c;
            margin-top: 0;
        }
        .preview-after h4 {
            color: #27ae60;
            margin-top: 0;
        }
        .highlight-change {
            background-color: #fff3cd;
            padding: 2px 4px;
            border-radius: 3px;
        }
        .settings-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        @media (max-width: 768px) {
            .settings-grid, .preview-section {
                grid-template-columns: 1fr;
            }
        }
    </style>

<!--[if gte mso 9]><xml>
<mso:CustomDocumentProperties>
<mso:_dlc_DocId msdt:dt="string">UJFKJ6WYH6MZ-1204683370-2055793</mso:_dlc_DocId>
<mso:_dlc_DocIdItemGuid msdt:dt="string">e6def0d3-8dbd-4f63-bc37-d82ea8f601f2</mso:_dlc_DocIdItemGuid>
<mso:_dlc_DocIdUrl msdt:dt="string">https://nabunken.sharepoint.com/sites/S_Planning-and-Coordination/S_&#25991;&#21270;&#36001;&#24773;&#22577;&#30740;&#31350;&#23460;/_layouts/15/DocIdRedir.aspx?ID=UJFKJ6WYH6MZ-1204683370-2055793, UJFKJ6WYH6MZ-1204683370-2055793</mso:_dlc_DocIdUrl>
</mso:CustomDocumentProperties>
</xml><![endif]-->
</head>
<body>
    <div class="container">
        <h1>📋 議事録専門用語修正ツール（拡張版）</h1>
        
        <!-- 設定セクション -->
        <div class="section">
            <h3>⚙️ 修正ルール設定</h3>
            <div class="tabs">
                <button class="tab active" onclick="switchTab('dictionary')">用語辞書</button>
                <button class="tab" onclick="switchTab('regex')">正規表現ルール</button>
                <button class="tab" onclick="switchTab('normalization')">文字正規化</button>
            </div>

            <!-- 用語辞書タブ -->
            <div id="dictionary" class="tab-content active">
                <div id="dictionary-list"></div>
                <div class="dictionary-item">
                    <input type="text" id="wrong-term" placeholder="間違った用語">
                    <span>→</span>
                    <input type="text" id="correct-term" placeholder="正しい用語">
                    <button class="btn" onclick="addDictionaryEntry()">追加</button>
                </div>
                <div style="margin-top: 15px;">
                    <button class="btn btn-warning" onclick="loadDefaultDictionary()">デフォルト辞書を読み込み</button>
                    <button class="btn" onclick="exportDictionary()">辞書をエクスポート</button>
                    <input type="file" id="dict-file" accept=".json,.csv" style="display:none" onchange="importDictionary()">
                    <button class="btn" onclick="document.getElementById('dict-file').click()">辞書をインポート</button>
                    <button class="btn btn-danger" onclick="clearDictionary()">辞書をクリア</button>
                </div>
            </div>

            <!-- 正規表現ルールタブ -->
            <div id="regex" class="tab-content">
                <div id="regex-rules-list"></div>
                <div class="regex-rule-item">
                    <input type="text" id="regex-pattern" placeholder="正規表現パターン" class="regex-pattern">
                    <input type="text" id="regex-replacement" placeholder="置換文字" class="regex-replacement">
                    <input type="text" id="regex-description" placeholder="説明" class="regex-description">
                    <button class="btn" onclick="addRegexRule()">追加</button>
                </div>
                <div style="margin-top: 15px;">
                    <button class="btn btn-warning" onclick="loadDefaultRegexRules()">デフォルトルールを読み込み</button>
                    <button class="btn btn-danger" onclick="clearRegexRules()">ルールをクリア</button>
                </div>
            </div>

            <!-- 文字正規化タブ -->
            <div id="normalization" class="tab-content">
                <h4>適用する正規化処理を選択:</h4>
                <div class="checkbox-group">
                    <div class="checkbox-item">
                        <input type="checkbox" id="normalize-katakana-length" checked>
                        <label for="normalize-katakana-length">カタカナ長音符統一（ーーー → ー）</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="normalize-fullwidth-numbers" checked>
                        <label for="normalize-fullwidth-numbers">全角数字を半角に（１２３ → 123）</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="normalize-fullwidth-alpha" checked>
                        <label for="normalize-fullwidth-alpha">全角英字を半角に（ＡＢＣ → ABC）</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="normalize-fullwidth-symbols" checked>
                        <label for="normalize-fullwidth-symbols">全角記号を半角に（！？（） → !?()）</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="normalize-spaces" checked>
                        <label for="normalize-spaces">スペース統一（全角・複数 → 半角単一）</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="normalize-quotes" checked>
                        <label for="normalize-quotes">引用符統一（"" → ""）</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="normalize-dashes" checked>
                        <label for="normalize-dashes">ダッシュ統一（―－ → -）</label>
                    </div>
                    <div class="checkbox-item">
                        <input type="checkbox" id="normalize-katakana-variants" checked>
                        <label for="normalize-katakana-variants">カタカナ表記統一（ヴァ → バ）</label>
                    </div>
                </div>
            </div>
        </div>

        <!-- ファイル処理 -->
        <div class="section">
            <h3>📄 ファイル処理</h3>
            <div class="file-input">
                <input type="file" id="file-input" multiple accept=".txt,.md" onchange="handleFileSelect()">
                <label for="file-input" class="btn">ファイルを選択</label>
                <button class="btn btn-success" onclick="processAllFiles()">全ファイル一括処理</button>
            </div>
            <div id="file-list"></div>
        </div>

        <!-- テキスト直接入力 -->
        <div class="section">
            <h3>✏️ テキスト直接修正</h3>
            <div class="preview-section">
                <div class="preview-before">
                    <h4>修正前</h4>
                    <textarea id="input-text" placeholder="修正したいテキストを入力してください..."></textarea>
                </div>
                <div class="preview-after">
                    <h4>修正後（プレビュー）</h4>
                    <textarea id="preview-text" placeholder="リアルタイムプレビュー..." readonly></textarea>
                </div>
            </div>
            <div style="text-align: center; margin-top: 15px;">
                <button class="btn btn-success" onclick="correctText()">修正実行</button>
                <button class="btn" onclick="clearText()">クリア</button>
                <button class="btn" onclick="toggleAutoPreview()">自動プレビュー ON/OFF</button>
            </div>
        </div>

        <!-- 結果表示 -->
        <div class="section">
            <h3>📊 修正結果</h3>
            <div class="stats">
                <div class="stat-item">
                    <div class="stat-number" id="total-changes">0</div>
                    <div>総修正数</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number" id="files-processed">0</div>
                    <div>処理ファイル数</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number" id="unique-corrections">0</div>
                    <div>修正種類数</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number" id="regex-corrections">0</div>
                    <div>正規化修正数</div>
                </div>
            </div>
            <div id="changes-display" class="changes-list" style="display:none;">
                <h4>修正内容:</h4>
                <div id="changes-list"></div>
            </div>
            <textarea id="output-text" placeholder="修正されたテキストがここに表示されます..." readonly></textarea>
            <div style="text-align: center; margin-top: 15px;">
                <button class="btn btn-success" onclick="downloadResult()" style="display:none;" id="download-btn">修正結果をダウンロード</button>
                <button class="btn" onclick="copyToClipboard()">クリップボードにコピー</button>
            </div>
        </div>
    </div>

    <script>
        class AdvancedTerminologyCorrector {
            constructor() {
                this.correctionDict = new Map();
                this.regexRules = [];
                this.autoPreview = true;
                this.loadDefaultDictionary();
                this.loadDefaultRegexRules();
                this.updateDictionaryDisplay();
                this.updateRegexRulesDisplay();
                this.setupEventListeners();
            }

            setupEventListeners() {
                const inputText = document.getElementById('input-text');
                inputText.addEventListener('input', () => {
                    if (this.autoPreview) {
                        this.updatePreview();
                    }
                });
            }

            loadDefaultDictionary() {
                const defaultTerms = {
                    // IT用語
                    "データーベース": "データベース",
                    "サーバー": "サーバ",
                    "コンピューター": "コンピュータ",
                    "プリンター": "プリンタ",
                    "スキャナー": "スキャナ",
                    "ユーザー": "ユーザ",
                    "マネージャー": "マネージャ",
                    "デベロッパー": "デベロッパ",
                    
                    // ビジネス用語
                    "アカウンタビリティー": "アカウンタビリティ",
                    "プライオリティー": "プライオリティ",
                    "アクティビティー": "アクティビティ",
                    "セキュリティー": "セキュリティ",
                    "クオリティー": "クオリティ",
                    
                    // よくある間違い
                    "ワークフロウ": "ワークフロー",
                    "ノーハウ": "ノウハウ",
                    "コミニケーション": "コミュニケーション",
                    "インフラストラクチャー": "インフラストラクチャ",
                    "アーキテクチャー": "アーキテクチャ",
                    
                    // 略語の統一
                    "ＡＩ": "AI",
                    "ＩｏＴ": "IoT",
                    "ＩＴ": "IT",
                    "ＵＩ": "UI",
                    "ＵＸ": "UX"
                };

                for (const [wrong, correct] of Object.entries(defaultTerms)) {
                    this.correctionDict.set(wrong, correct);
                }
            }

            loadDefaultRegexRules() {
                this.regexRules = [
                    {
                        pattern: 'ー{2,}',
                        replacement: 'ー',
                        description: 'カタカナ長音符統一（複数の長音符を1つに）',
                        enabled: true
                    },
                    {
                        pattern: '[０-９]',
                        replacement: (match) => String.fromCharCode(match.charCodeAt(0) - 0xFF10 + 0x30),
                        description: '全角数字を半角に変換',
                        enabled: true
                    },
                    {
                        pattern: '[Ａ-Ｚａ-ｚ]',
                        replacement: (match) => String.fromCharCode(match.charCodeAt(0) - (match <= 'Ｚ' ? 0xFF21 : 0xFF41) + (match <= 'Ｚ' ? 0x41 : 0x61)),
                        description: '全角英字を半角に変換',
                        enabled: true
                    },
                    {
                        pattern: '[！？（）［］｛｝「」『』＜＞]',
                        replacement: (match) => {
                            const map = {
                                '！': '!', '？': '?', '（': '(', '）': ')',
                                '［': '[', '］': ']', '｛': '{', '｝': '}',
                                '「': '「', '」': '」', '『': '『', '』': '』',
                                '＜': '<', '＞': '>'
                            };
                            return map[match] || match;
                        },
                        description: '全角記号を半角に変換',
                        enabled: true
                    },
                    {
                        pattern: '　+',
                        replacement: ' ',
                        description: '全角スペースを半角スペースに変換',
                        enabled: true
                    },
                    {
                        pattern: ' {2,}',
                        replacement: ' ',
                        description: '複数の半角スペースを1つに統一',
                        enabled: true
                    },
                    {
                        pattern: '["""]',
                        replacement: '"',
                        description: '引用符を統一',
                        enabled: true
                    },
                    {
                        pattern: '[―－‐]',
                        replacement: '-',
                        description: 'ダッシュ記号を統一',
                        enabled: true
                    },
                    {
                        pattern: 'ヴ([ァ-ォ])',
                        replacement: 'バ$1',
                        description: 'ヴァ行をバ行に変換',
                        enabled: false
                    }
                ];
            }

            addCorrection(wrongTerm, correctTerm) {
                if (wrongTerm && correctTerm) {
                    this.correctionDict.set(wrongTerm, correctTerm);
                    this.updateDictionaryDisplay();
                }
            }

            removeCorrection(wrongTerm) {
                this.correctionDict.delete(wrongTerm);
                this.updateDictionaryDisplay();
            }

            addRegexRule(pattern, replacement, description) {
                if (pattern && replacement && description) {
                    this.regexRules.push({
                        pattern,
                        replacement,
                        description,
                        enabled: true
                    });
                    this.updateRegexRulesDisplay();
                }
            }

            removeRegexRule(index) {
                this.regexRules.splice(index, 1);
                this.updateRegexRulesDisplay();
            }

            toggleRegexRule(index) {
                this.regexRules[index].enabled = !this.regexRules[index].enabled;
                this.updateRegexRulesDisplay();
            }

            correctText(text) {
                let correctedText = text;
                const changes = [];
                const regexChanges = [];

                // 辞書による置換
                for (const [wrongTerm, correctTerm] of this.correctionDict) {
                    const regex = new RegExp(wrongTerm.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'g');
                    const matches = correctedText.match(regex);
                    if (matches) {
                        correctedText = correctedText.replace(regex, correctTerm);
                        changes.push({
                            wrong: wrongTerm,
                            correct: correctTerm,
                            count: matches.length
                        });
                    }
                }

                // 正規表現による修正（有効なもののみ）
                for (const rule of this.regexRules.filter(r => r.enabled)) {
                    const regex = new RegExp(rule.pattern, 'g');
                    const beforeCorrection = correctedText;
                    
                    if (typeof rule.replacement === 'function') {
                        correctedText = correctedText.replace(regex, rule.replacement);
                    } else {
                        correctedText = correctedText.replace(regex, rule.replacement);
                    }
                    
                    if (beforeCorrection !== correctedText) {
                        const matchCount = (beforeCorrection.match(regex) || []).length;
                        regexChanges.push({
                            description: rule.description,
                            pattern: rule.pattern,
                            count: matchCount
                        });
                    }
                }

                // 文字正規化処理
                const normalizationSettings = this.getNormalizationSettings();
                if (normalizationSettings.katakanaLength) {
                    const before = correctedText;
                    correctedText = correctedText.replace(/ー{2,}/g, 'ー');
                    if (before !== correctedText) {
                        regexChanges.push({
                            description: 'カタカナ長音符統一',
                            pattern: 'ー{2,}',
                            count: (before.match(/ー{2,}/g) || []).length
                        });
                    }
                }

                return { correctedText, changes, regexChanges };
            }

            getNormalizationSettings() {
                return {
                    katakanaLength: document.getElementById('normalize-katakana-length').checked,
                    fullwidthNumbers: document.getElementById('normalize-fullwidth-numbers').checked,
                    fullwidthAlpha: document.getElementById('normalize-fullwidth-alpha').checked,
                    fullwidthSymbols: document.getElementById('normalize-fullwidth-symbols').checked,
                    spaces: document.getElementById('normalize-spaces').checked,
                    quotes: document.getElementById('normalize-quotes').checked,
                    dashes: document.getElementById('normalize-dashes').checked,
                    katakanaVariants: document.getElementById('normalize-katakana-variants').checked
                };
            }

            updatePreview() {
                const inputText = document.getElementById('input-text').value;
                if (inputText.trim()) {
                    const result = this.correctText(inputText);
                    document.getElementById('preview-text').value = result.correctedText;
                } else {
                    document.getElementById('preview-text').value = '';
                }
            }

            updateDictionaryDisplay() {
                const container = document.getElementById('dictionary-list');
                container.innerHTML = '';

                for (const [wrong, correct] of this.correctionDict) {
                    const item = document.createElement('div');
                    item.className = 'dictionary-item';
                    item.innerHTML = `
                        <input type="text" value="${wrong}" readonly>
                        <span>→</span>
                        <input type="text" value="${correct}" readonly>
                        <button class="btn btn-danger" onclick="corrector.removeCorrection('${wrong.replace(/'/g, "\\'")}')">削除</button>
                    `;
                    container.appendChild(item);
                }
            }

            updateRegexRulesDisplay() {
                const container = document.getElementById('regex-rules-list');
                container.innerHTML = '';

                this.regexRules.forEach((rule, index) => {
                    const item = document.createElement('div');
                    item.className = 'regex-rule-item';
                    item.innerHTML = `
                        <input type="checkbox" ${rule.enabled ? 'checked' : ''} onchange="corrector.toggleRegexRule(${index})">
                        <input type="text" value="${rule.pattern}" readonly class="regex-pattern">
                        <input type="text" value="${typeof rule.replacement === 'function' ? '[Function]' : rule.replacement}" readonly class="regex-replacement">
                        <div class="regex-description">${rule.description}</div>
                        <button class="btn btn-danger" onclick="corrector.removeRegexRule(${index})">削除</button>
                    `;
                    container.appendChild(item);
                });
            }

            exportDictionary() {
                const dict = Object.fromEntries(this.correctionDict);
                const exportData = {
                    dictionary: dict,
                    regexRules: this.regexRules.filter(rule => !rule.replacement.toString().includes('function'))
                };
                const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'terminology_settings.json';
                a.click();
                URL.revokeObjectURL(url);
            }

            importDictionary(file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const data = JSON.parse(e.target.result);
                        
                        if (data.dictionary) {
                            for (const [wrong, correct] of Object.entries(data.dictionary)) {
                                this.correctionDict.set(wrong, correct);
                            }
                        }
                        
                        if (data.regexRules) {
                            this.regexRules = [...this.regexRules, ...data.regexRules];
                        }
                        
                        this.updateDictionaryDisplay();
                        this.updateRegexRulesDisplay();
                        alert('設定をインポートしました');
                    } catch (error) {
                        alert('ファイルの形式が正しくありません');
                    }
                };
                reader.readAsText(file);
            }
        }

        const corrector = new AdvancedTerminologyCorrector();
        let processedFiles = [];

        function switchTab(tabName) {
            // タブの切り替え
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(tabName).classList.add('active');
        }

        function addDictionaryEntry() {
            const wrongTerm = document.getElementById('wrong-term').value.trim();
            const correctTerm = document.getElementById('correct-term').value.trim();
            
            if (wrongTerm && correctTerm) {
                corrector.addCorrection(wrongTerm, correctTerm);
                document.getElementById('wrong-term').value = '';
                document.getElementById('correct-term').value = '';
            } else {
                alert('両方の項目を入力してください');
            }
        }

        function addRegexRule() {
            const pattern = document.getElementById('regex-pattern').value.trim();
            const replacement = document.getElementById('regex-replacement').value.trim();
            const description = document.getElementById('regex-description').value.trim();
            
            if (pattern && replacement && description) {
                corrector.addRegexRule(pattern, replacement, description);
                document.getElementById('regex-pattern').value = '';
                document.getElementById('regex-replacement').value = '';
                document.getElementById('regex-description').value = '';
            } else {
                alert('すべての項目を入力してください');
            }
        }

        function loadDefaultDictionary() {
            corrector.loadDefaultDictionary();
            corrector.updateDictionaryDisplay();
            alert('デフォルト辞書を読み込みました');
        }

        function loadDefaultRegexRules() {
            corrector.loadDefaultRegexRules();
            corrector.updateRegexRulesDisplay();
            alert('デフォルト正規表現ルールを読み込みました');
        }

        function clearDictionary() {
            if (confirm('辞書をクリアしますか？')) {
                corrector.correctionDict.clear();
                corrector.updateDictionaryDisplay();
            }
        }

        function clearRegexRules() {
            if (confirm('正規表現ルールをクリアしますか？')) {
                corrector.regexRules = [];
                corrector.updateRegexRulesDisplay();
            }
        }

        function exportDictionary() {
            corrector.exportDictionary();
        }

        function importDictionary() {
            const file = document.getElementById('dict-file').files[0];
            if (file) {
                corrector.importDictionary(file);
            }
        }

        function handleFileSelect() {
            const files = document.getElementById('file-input').files;
            const fileList = document.getElementById('file-list');
            fileList.innerHTML = '';

            Array.from(files).forEach((file, index) => {
                const item = document.createElement('div');
                item.style.cssText = 'margin: 10px 0; padding: 10px; background-color: #f8f9fa; border-radius: 5px;';
                item.innerHTML = `
                    <span style="font-weight: bold;">${file.name}</span>
                    <span style="color: #666; margin-left: 10px;">(${(file.size / 1024).toFixed(1)} KB)</span>
                    <button class="btn" onclick="processFile(${index})">個別処理</button>
                `;
                fileList.appendChild(item);
            });
        }

        function processFile(fileIndex) {
            const files = document.getElementById('file-input').files;
            const file = files[fileIndex];
            
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const result = corrector.correctText(e.target.result);
                    document.getElementById('output-text').value = result.correctedText;
                    displayChanges(result.changes, result.regexChanges);
                    updateStats([...result.changes, ...result.regexChanges], 1, result.regexChanges.length);
                    document.getElementById('download-btn').style.display = 'inline-block';
                };
                reader.readAsText(file);
            }
        }

        function processAllFiles() {
            const files = document.getElementById('file-input').files;
            if (files.length === 0) {
                alert('ファイルを選択してください');
                return;
            }

            let allResults = '';
            let totalChanges = [];
            let totalRegexChanges = [];
            let processedCount = 0;

            Array.from(files).forEach((file, index) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const result = corrector.correctText(e.target.result);
                    allResults += `\n\n--- ${file.name} ---\n${result.correctedText}`;
                    totalChanges.push(...result.changes);
                    totalRegexChanges.push(...result.regexChanges);
                    processedCount++;

                    if (processedCount === files.length) {
                        document.getElementById('output-text').value = allResults;
                        displayChanges(totalChanges, totalRegexChanges);
                        updateStats([...totalChanges, ...totalRegexChanges], files.length, totalRegexChanges.length);
                        document.getElementById('download-btn').style.display = 'inline-block';
                    }
                };
                reader.readAsText(file);
            });
        }

        function correctText() {
            const inputText = document.getElementById('input-text').value;
            if (!inputText.trim()) {
                alert('修正するテキストを入力してください');
                return;
            }

            const result = corrector.correctText(inputText);
            document.getElementById('output-text').value = result.correctedText;
            displayChanges(result.changes, result.regexChanges);
            updateStats([...result.changes, ...result.regexChanges], 1, result.regexChanges.length);
            document.getElementById('download-btn').style.display = 'inline-block';
        }

        function clearText() {
            document.getElementById('input-text').value = '';
            document.getElementById('output-text').value = '';
            document.getElementById('preview-text').value = '';
            document.getElementById('changes-display').style.display = 'none';
            updateStats([], 0, 0);
            document.getElementById('download-btn').style.display = 'none';
        }

        function toggleAutoPreview() {
            corrector.autoPreview = !corrector.autoPreview;
            const btn = event.target;
            btn.textContent = `自動プレビュー ${corrector.autoPreview ? 'ON' : 'OFF'}`;
            btn.style.backgroundColor = corrector.autoPreview ? '#27ae60' : '#95a5a6';
        }

        function displayChanges(changes, regexChanges) {
            const changesContainer = document.getElementById('changes-display');
            const changesList = document.getElementById('changes-list');
            
            const totalChanges = changes.length + (regexChanges ? regexChanges.length : 0);
            
            if (totalChanges > 0) {
                changesContainer.style.display = 'block';
                changesList.innerHTML = '';
                
                // 辞書による修正
                changes.forEach(change => {
                    const item = document.createElement('div');
                    item.className = 'change-item';
                    item.innerHTML = `<strong>${change.wrong}</strong> → <strong>${change.correct}</strong> (${change.count}箇所)`;
                    changesList.appendChild(item);
                });

                // 正規表現による修正
                if (regexChanges) {
                    regexChanges.forEach(change => {
                        const item = document.createElement('div');
                        item.className = 'change-item regex-change-item';
                        item.innerHTML = `[正規化] <strong>${change.description}</strong> (${change.count}箇所)`;
                        changesList.appendChild(item);
                    });
                }
            } else {
                changesContainer.style.display = 'none';
            }
        }

        function updateStats(changes, fileCount, regexCount) {
            const totalChanges = changes.reduce((sum, change) => sum + (change.count || 1), 0);
            document.getElementById('total-changes').textContent = totalChanges;
            document.getElementById('files-processed').textContent = fileCount;
            document.getElementById('unique-corrections').textContent = changes.length;
            document.getElementById('regex-corrections').textContent = regexCount;
        }

        function downloadResult() {
            const result = document.getElementById('output-text').value;
            if (result) {
                const blob = new Blob([result], { type: 'text/plain' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'corrected_text.txt';
                a.click();
                URL.revokeObjectURL(url);
            }
        }

        function copyToClipboard() {
            const result = document.getElementById('output-text').value;
            if (result) {
                navigator.clipboard.writeText(result).then(() => {
                    alert('クリップボードにコピーしました');
                }).catch(() => {
                    alert('コピーに失敗しました');
                });
            }
        }

        // 初期化
        document.addEventListener('DOMContentLoaded', function() {
            corrector.updatePreview();
        });
    </script>
</body>
</html>